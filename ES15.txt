CREATE OR REPLACE PROCEDURE CORSISTA2.esercizio15(v_IDArea IN NUMBER, v_riuscita OUT BOOLEAN, v_ordini OUT NUMBER, v_fatturato OUT NUMBER)IS
-- 15. Realizzare una Stored Procedure che calcola e restituisce il totale degli ordini emessi (Ordine di Acquisto) su una Area
-- (IDArea parametro in ngresso) ed il totale delle fatture ricevute (Fatture Passive) sempre per la stessa Area.
-- La Stored Procedure deve, calcolare il totale degli Ordini di Acquisto emesso, il totale fatturato ricevuto
-- (la somma degli importi dei dettagli delle fatture passive) e restituire l esito della procedura.
CURSOR fatturato_cursor IS
    SELECT D.IMPORTO
    FROM FATTURAPASSIVADETTAGLIO D, SPESAINVESTIMENTO SI, SOTTOCATEGORIA SC, AREA A
    WHERE A.IDAREA = v_IDArea
    AND SC.IDAREA = A.IDAREA
    AND SI.IDSOTTOCATEGORIA = SC.IDSOTTOCATEGORIA
    AND D.IDSPESAINVESTIMENTO = SI.IDSPESAINVESTIMENTO;
CURSOR ordinato_cursor IS
    SELECT O.IMPORTO
    FROM ORDINEACQUISTO O, ORDINEDIACQUISTODETTAGLIO D, SPESAINVESTIMENTO SI, SOTTOCATEGORIA SC, AREA A
    WHERE A.IDAREA = v_IDArea
    AND SC.IDAREA = A.IDAREA
    AND SI.IDSOTTOCATEGORIA = SC.IDSOTTOCATEGORIA
    AND D.IDSPESAINVESTIMENTO = SI.IDSPESAINVESTIMENTO
    AND O.IDORDINEACQUISTO = D.IDORDINEACQUISTO;
v_controllo NUMBER;
v_ordini_presenti BOOLEAN :=FALSE;
v_fatture_presenti BOOLEAN :=FALSE;
BEGIN
    SELECT IDAREA
    INTO v_controllo
    FROM AREA
    WHERE IDAREA = v_IDArea;
    
    v_riuscita :=FALSE;
    v_ordini :=0;
    FOR ordinato_record IN ordinato_cursor LOOP
        v_ordini := v_ordini + ordinato_record.importo;
        IF v_ordini_presenti = FALSE THEN
            v_ordini_presenti :=TRUE;
        END IF;
    END LOOP;
    
    v_fatturato :=0;
    FOR fatturato_record IN fatturato_cursor LOOP
        v_fatturato := v_fatturato + fatturato_record.importo;
        IF v_fatture_presenti = FALSE THEN
            v_fatture_presenti :=TRUE;
        END IF;
    END LOOP;
    
    IF v_ordini_presenti = TRUE THEN
       DBMS_OUTPUT.PUT_LINE('Il totale degli Ordini emessi per la Area ' || v_IDArea || ' vale ' || v_ordini || '€');
       v_riuscita :=TRUE;
    ELSE
        DBMS_OUTPUT.PUT_LINE('Non risultano Ordini emessi per la Area inserita');
    END IF; 
    
    IF v_fatture_presenti = TRUE THEN
       DBMS_OUTPUT.PUT_LINE('Il totale Fatturato ricevuto per la Area ' || v_IDArea || ' vale ' || v_fatturato || '€');
       IF v_riuscita = FALSE THEN
            v_riuscita :=TRUE;
       END IF;
    ELSE
        DBMS_OUTPUT.PUT_LINE('Non risulta Fatturato ricevuto per la Area inserita');
    END IF; 
    

    EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Non esistono Aree con lo ID inserito');
         v_riuscita :=FALSE;
END;
/